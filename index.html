<script>
const LATEST_URL = "./data/latest.json?ts=" + Date.now();

async function fetchLatest() {
  const res = await fetch("./data/latest.json?ts=" + Date.now());
  if (!res.ok) throw new Error("Failed to fetch latest.json: " + res.status);
  return res.json();
}

function renderTable(markets) {
  const table = document.getElementById("rates");

  // clear old rows except header
  while (table.rows.length > 1) table.deleteRow(1);

  for (const m of markets) {
    const row = table.insertRow();
    row.insertCell(0).innerText = m.symbol || m.market || "â€“";
    row.insertCell(1).innerText = (m.supplyApy * 100).toFixed(2) + "%";
    row.insertCell(2).innerText = (m.borrowApy * 100).toFixed(2) + "%";
    row.insertCell(3).innerText = (m.utilization * 100).toFixed(2) + "%";
  }
}

async function loadAndRender() {
  try {
    const data = await fetchLatest();
    document.getElementById("lastUpdated").innerText = new Date(data.updatedAt).toLocaleString();
    renderTable(data.markets);
  } catch (err) {
    console.error(err);
    // show user-friendly error in the table
    const table = document.getElementById("rates");
    while (table.rows.length > 1) table.deleteRow(1);
    const row = table.insertRow();
    row.insertCell(0).innerText = "Error loading data";
    row.insertCell(1).innerText = "-";
    row.insertCell(2).innerText = "-";
    row.insertCell(3).innerText = "-";
  }
}

loadAndRender();
setInterval(loadAndRender, 60000);
</script>
